<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±è¼‰å…¥ä¸­...</title>
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”—</text></svg>">
    <style>
        /* --- æ ¸å¿ƒ CSS (æ‰€æœ‰äººéƒ½æœƒè¼‰å…¥) --- */
        :root { --primary: #2c3e50; --bg: #f4f7f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", "Helvetica Neue", Arial, sans-serif; margin: 0; background: var(--bg); color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .hidden { display: none !important; }
        
        /* è¼‰å…¥å‹•ç•« (Spinner) */
        .loader { border: 4px solid #e1e1e1; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* éŒ¯èª¤è¨Šæ¯ */
        .error-box { background: #ffeaea; color: #c0392b; padding: 15px; border-radius: 8px; text-align: center; max-width: 90%; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* --- ç®¡ç†ä»‹é¢ CSS (ç™»å…¥å¾Œæ‰é¡¯ç¤º) --- */
        #app-container { width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; transition: transform 0.2s; }
        h1 { margin: 0 0 10px; color: var(--primary); font-size: 1.8rem; }
        p.subtitle { color: #7f8c8d; margin-top: 0; font-size: 0.9rem; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; }
        
        button { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1rem; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }
        button.secondary { background: #ecf0f1; color: #7f8c8d; }
        button.small { width: auto; padding: 6px 12px; font-size: 0.85rem; margin: 0; }
        button.danger { background: #e74c3c; }

        /* åˆ—è¡¨æ¨£å¼ */
        .link-item { border-bottom: 1px solid #eee; padding: 15px 0; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .link-info h3 { margin: 0 0 5px; font-size: 1rem; color: var(--primary); }
        .link-meta { font-size: 0.75rem; color: #95a5a6; }
        .link-actions { display: flex; gap: 5px; }

        /* QR Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 999; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; }
        #logo-preview { max-height: 60px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="loading-view" style="text-align: center;">
        <div class="loader"></div>
        <p id="loading-text" style="color:#7f8c8d; font-size:0.9rem;">ç³»çµ±è™•ç†ä¸­...</p>
    </div>

    <div id="error-view" class="hidden">
        <div class="error-box">
            <h3>âš ï¸ é€£çµç„¡æ•ˆ</h3>
            <p id="error-msg">æ‰¾ä¸åˆ°æ­¤é é¢ï¼Œè«‹ç¢ºèªç¶²å€æ˜¯å¦æ­£ç¢ºã€‚</p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="login-card" class="card">
            <img id="brand-logo" src="" alt="Logo" class="hidden" style="height:60px; margin-bottom:10px;">
            <h1 id="brand-title">ç®¡ç†å“¡ç™»å…¥</h1>
            <p class="subtitle">è«‹é©—è­‰æ‚¨çš„èº«åˆ†ä»¥ç®¡ç†é€£çµ</p>
            <input type="password" id="admin-pwd" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼">
            <button onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
        </div>

        <div id="dashboard-card" class="card hidden" style="text-align: left;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">ç®¡ç†æ§åˆ¶å°</h2>
                <button class="small secondary" onclick="logout()">ç™»å‡º</button>
            </div>
            
            <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:20px;">
                <input type="url" id="new-url" placeholder="è¼¸å…¥åŸå§‹é•·ç¶²å€ (https://...)" onchange="autoFillTitle()">
                <input type="text" id="new-title" placeholder="æ¨™é¡Œ (ç•™ç©ºå‰‡è‡ªå‹•æŠ“å–)">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="new-shortid" placeholder="è‡ªè¨‚çŸ­ç¢¼ (é¸å¡«)" style="width:40%;">
                    <input type="text" id="new-note" placeholder="å‚™è¨» (é¸å¡«)">
                </div>
                <button onclick="createLink()" id="btn-create">âœ¨ å»ºç«‹çŸ­ç¶²å€</button>
            </div>

            <div id="links-list">
                <div class="loader"></div>
            </div>
        </div>
    </div>

    <div id="qr-modal" class="modal hidden">
        <div class="modal-content">
            <h3>QR Code åˆ†äº«</h3>
            <div id="qr-canvas"></div>
            <br>
            <button onclick="downloadQR()">ä¸‹è¼‰åœ–ç‰‡ (PNG)</button>
            <button class="secondary" onclick="closeQR()">é—œé–‰</button>
        </div>
    </div>

    <script>
        // ==========================================
        // â˜…â˜…â˜… è¨­å®šå€ï¼šè«‹å°‡ä¸‹æ–¹å¼•è™Ÿå…§çš„ç¶²å€æ›æˆæ‚¨çš„ GAS Web App URL â˜…â˜…â˜…
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxlTu9OlKzukjJV1ztGPOwqEq9m_57kbvq04a0FsP-mbkb3-HG9y5dkN4_d57PuzUVICQ/exec"; 
        // ==========================================

        // å…¨åŸŸè®Šæ•¸
        let config = {};
        const urlParams = new URLSearchParams(window.location.search);
        const linkId = urlParams.get('id');

        // --- æ ¸å¿ƒå…¥å£ ---
        (function init(){
            if (linkId) {
                // [æ¨¡å¼ A] è¨ªå®¢è½‰å€æ¨¡å¼
                executeRedirect(linkId);
            } else {
                // [æ¨¡å¼ B] ç®¡ç†å“¡æ¨¡å¼
                initAdminView();
            }
        })();

        // --- [A] è¨ªå®¢è½‰å€é‚è¼¯ ---
        function executeRedirect(id) {
            document.getElementById('loading-text').innerText = "æ­£åœ¨è®€å–è³‡æ–™...";
            
            // å‘¼å«å¾Œç«¯ API
            fetch(`${GAS_URL}?action=getLink&id=${id}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        // 1. GA4 è¿½è¹¤ (å¦‚æœå¾Œç«¯æœ‰å›å‚³ GA ID)
                        if (data.ga) {
                            loadGA(data.ga);
                            gtag('event', 'short_link_click', {
                                'event_category': 'engagement',
                                'event_label': id
                            });
                        }
                        // 2. åŸ·è¡Œè½‰å€
                        document.getElementById('loading-text').innerText = "æ­£åœ¨å‰å¾€ç›®çš„åœ°...";
                        setTimeout(() => {
                            window.location.replace(data.url);
                        }, 200); // çµ¦ GA ä¸€é»é»æ™‚é–“ç™¼é€ï¼Œä¸é˜»æ“‹å¤ªä¹…
                    } else {
                        showError(data.message === "Link not found" ? "æ‰¾ä¸åˆ°æ­¤çŸ­ç¶²å€" : data.message);
                    }
                })
                .catch(err => showError("ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦"));
        }

        // --- [B] ç®¡ç†å“¡é‚è¼¯ ---
        function initAdminView() {
            // éš±è— loadingï¼ŒæŠ“å–è¨­å®šä»¥æ¸²æŸ“å“ç‰Œ
            fetch(`${GAS_URL}?action=getConfig`)
                .then(r => r.json())
                .then(res => {
                    document.getElementById('loading-view').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    
                    if(res.status === "success") {
                        config = res.data;
                        applyBranding(config);
                    }
                });
        }

        function handleLogin() {
            const pwd = document.getElementById('admin-pwd').value;
            if(!pwd) return alert("è«‹è¼¸å…¥å¯†ç¢¼");

            const btn = document.querySelector('#login-card button');
            btn.disabled = true; btn.innerText = "é©—è­‰ä¸­...";

            // å¾Œç«¯é©—è­‰
            fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "login", password: pwd })
            }).then(r => r.json()).then(d => {
                if(d.status === "success") {
                    // ç™»å…¥æˆåŠŸ
                    document.getElementById('login-card').classList.add('hidden');
                    document.getElementById('dashboard-card').classList.remove('hidden');
                    loadLinks();
                    loadQRLib(); // æ‡¶åŠ è¼‰ QR åº«
                } else {
                    alert("å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦");
                    btn.disabled = false; btn.innerText = "ç™»å…¥ç³»çµ±";
                }
            });
        }

        function createLink() {
            const p = {
                action: "create",
                url: document.getElementById('new-url').value,
                title: document.getElementById('new-title').value,
                shortId: document.getElementById('new-shortid').value,
                note: document.getElementById('new-note').value
            };
            if(!p.url) return alert("è«‹è¼¸å…¥ç¶²å€ï¼");

            const btn = document.getElementById('btn-create');
            btn.disabled = true; btn.innerText = "è™•ç†ä¸­...";

            fetch(GAS_URL, { method:"POST", body:JSON.stringify(p) })
                .then(r=>r.json()).then(d => {
                    btn.disabled = false; btn.innerText = "âœ¨ å»ºç«‹çŸ­ç¶²å€";
                    if(d.status === "success") {
                        alert(`æˆåŠŸï¼çŸ­ç¶²å€ä»£ç¢¼ç‚ºï¼š ${d.shortId}`);
                        document.getElementById('new-url').value = "";
                        document.getElementById('new-title').value = "";
                        document.getElementById('new-shortid').value = "";
                        loadLinks(); // é‡æ–°æ•´ç†åˆ—è¡¨
                    } else {
                        alert("å¤±æ•—: " + d.message);
                    }
                });
        }

        function loadLinks() {
            const list = document.getElementById('links-list');
            list.innerHTML = '<div class="loader"></div>';
            
            // é€™è£¡ç°¡åŒ–ï¼Œç›´æ¥å‘¼å« getAllã€‚å¯¦éš›å»ºè­°å¸¶ä¸Š token
            fetch(`${GAS_URL}?action=getAll`)
                .then(r=>r.json()).then(res => {
                    if(res.status !== "success") return list.innerHTML = "è¼‰å…¥å¤±æ•—";
                    
                    let html = "";
                    const origin = window.location.origin + window.location.pathname;
                    
                    res.data.forEach(item => {
                        // ä¿®æ­£çµå°¾æ–œç·šå•é¡Œï¼Œç¢ºä¿ç¶²å€ç¾è§€
                        const baseUrl = origin.endsWith('/') ? origin : origin + '/';
                        const shortUrl = `${origin}?id=${item.shortId}`;
                        
                        html += `
                        <div class="link-item">
                            <div class="link-info">
                                <h3>${item.title || '(ç„¡æ¨™é¡Œ)'}</h3>
                                <div class="link-meta">
                                    <a href="${shortUrl}" target="_blank" style="color:#3498db;text-decoration:none;">/${item.shortId}</a> 
                                    â€¢ ${item.clicks} æ¬¡é»æ“Š â€¢ ${item.date}
                                </div>
                            </div>
                            <div class="link-actions">
                                <button class="small secondary" onclick="copy('${shortUrl}')">è¤‡è£½</button>
                                <button class="small secondary" onclick="showQR('${shortUrl}')">QR</button>
                                <button class="small danger" onclick="deleteLink('${item.shortId}')">åˆªé™¤</button>
                            </div>
                        </div>`;
                    });
                    list.innerHTML = html || "<p style='color:#ccc;text-align:center'>ç›®å‰æ²’æœ‰ä»»ä½•é€£çµã€‚</p>";
                });
        }

        function deleteLink(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é€£çµå—ï¼Ÿ")) return;
            fetch(GAS_URL, {method:"POST", body:JSON.stringify({action:"delete", id:id})})
                .then(r=>r.json()).then(()=>loadLinks());
        }

        // --- è¼”åŠ©åŠŸèƒ½ ---
        function applyBranding(cfg) {
            if(cfg.SystemTitle) document.title = cfg.SystemTitle;
            if(cfg.ThemeColor) document.documentElement.style.setProperty('--primary', cfg.ThemeColor);
            if(cfg.PageLogo) {
                const img = document.getElementById('brand-logo');
                img.src = cfg.PageLogo;
                img.classList.remove('hidden');
            }
            if(cfg.SiteFavicon) document.getElementById('favicon').href = cfg.SiteFavicon;
        }

        function showError(msg) {
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById('error-view').classList.remove('hidden');
            document.getElementById('error-msg').innerText = msg;
        }

        function copy(text) {
            navigator.clipboard.writeText(text).then(()=>alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼"));
        }
        
        function autoFillTitle() {
             // æ¨™é¡Œè‡ªå‹•æŠ“å–å·²ç§»è‡³å¾Œç«¯ï¼Œå‰ç«¯ä¿æŒç©ºç™½å³å¯
        }

        function logout() { location.reload(); }

        // --- å‹•æ…‹è¼‰å…¥è³‡æº (Lazy Load) ---
        let qrLibLoaded = false;
        let qrCodeObj = null;

        function loadQRLib() {
            if(qrLibLoaded) return;
            const script = document.createElement('script');
            script.src = "https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js";
            script.onload = () => { qrLibLoaded = true; };
            document.body.appendChild(script);
        }

        function showQR(url) {
            if(!qrLibLoaded) return alert("QR Code å…ƒä»¶è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...");
            document.getElementById('qr-modal').classList.remove('hidden');
            document.getElementById('qr-canvas').innerHTML = "";
            
            qrCodeObj = new QRCodeStyling({
                width: 250, height: 250,
                data: url,
                dotsOptions: { color: config.ThemeColor || "#2c3e50", type: "rounded" },
                backgroundOptions: { color: "#ffffff" }
            });
            qrCodeObj.append(document.getElementById('qr-canvas'));
        }
        
        function downloadQR(){ if(qrCodeObj) qrCodeObj.download({ name: "qr-code", extension: "png" }); }
        function closeQR(){ document.getElementById('qr-modal').classList.add('hidden'); }

        // --- GA4 æ•´åˆ ---
        function loadGA(id) {
            const script = document.createElement('script');
            script.src = `https://www.googletagmanager.com/gtag/js?id=${id}`;
            script.async = true;
            document.head.appendChild(script);
            window.dataLayer = window.dataLayer || [];
            window.gtag = function(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', id);
        }
    </script>
</body>
</html>
