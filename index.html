<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±è¼‰å…¥ä¸­...</title>
    
    <script>
        // è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ GAS Web App URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxlTu9OlKzukjJV1ztGPOwqEq9m_57kbvq04a0FsP-mbkb3-HG9y5dkN4_d57PuzUVICQ/exec"; 
        const SYS_VERSION = "v3.1"; // ç³»çµ±ç‰ˆæœ¬è™Ÿ
    </script>
    <meta property="og:title" content="æˆ‘çš„çŸ­ç¶²å€ç³»çµ±">
    <meta property="og:description" content="å°ˆå±¬é€£çµç®¡ç†æœå‹™">
    <meta property="og:image" content="https://cdn-icons-png.flaticon.com/512/633/633642.png">
    
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”—</text></svg>">
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --danger: #e74c3c; --warn: #f39c12; }
        body { font-family: "Microsoft JhengHei", -apple-system, sans-serif; margin: 0; background: var(--bg); color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .hidden { display: none !important; }
        
        .loader { border: 4px solid #e1e1e1; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .error-box { background: #ffeaea; color: #c0392b; padding: 20px; border-radius: 8px; text-align: center; max-width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .expired-box { background: #fff3cd; color: #856404; padding: 20px; border-radius: 8px; text-align: center; max-width: 90%; border: 1px solid #ffeeba; }

        #app-container { width: 100%; max-width: 800px; padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; }
        
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; }
        
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.95rem; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.secondary { background: #ecf0f1; color: #555; }
        button.small { padding: 4px 8px; font-size: 0.8rem; margin-left: 5px; }
        button.danger { background: var(--danger); }
        button.warn { background: var(--warn); }

        .search-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .link-item { border-bottom: 1px solid #eee; padding: 15px 0; text-align: left; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .link-info { flex: 1; min-width: 200px; }
        .link-tags span { background: #eef2f7; color: #555; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
        .link-meta { font-size: 0.8rem; color: #999; margin-top: 4px; }
        .expired-tag { color: var(--danger); font-weight: bold; font-size: 0.8rem; border: 1px solid var(--danger); padding: 0 4px; border-radius: 4px; }
        
        .version-tag { font-size: 0.75rem; color: #ccc; margin-top: 15px; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; text-align: left; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 10px; }
        .form-group label { font-size: 0.85rem; font-weight: bold; color: #555; display: block; margin-bottom: 3px; }
        .row { display: flex; gap: 10px; }
    </style>
</head>
<body>

    <div id="loading-view" style="text-align: center;">
        <div class="loader"></div>
        <p id="loading-text" style="color:#7f8c8d;">è™•ç†ä¸­...</p>
    </div>

    <div id="status-view" class="hidden"></div>

    <div id="app-container" class="hidden">
        <div id="login-card" class="card">
            <img id="brand-logo" src="" alt="Logo" class="hidden" style="height:60px; margin-bottom:10px;">
            <h1 id="brand-title">ç®¡ç†å“¡ç™»å…¥</h1>
            <input type="password" id="admin-pwd" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼">
            <button onclick="handleLogin()" style="width:100%; margin-top:10px;">ç™»å…¥</button>
            <div id="version-display" class="version-tag"></div>
        </div>

        <div id="dashboard-card" class="hidden">
            <div class="card" style="text-align: left; padding: 15px 25px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0; font-size:1.4rem;">æ§åˆ¶å°</h2>
                    <div>
                        <button onclick="openModal('create')">â• æ–°å¢</button>
                        <button class="secondary" onclick="logout()">ç™»å‡º</button>
                    </div>
                </div>
            </div>

            <div class="card" style="text-align: left;">
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="ğŸ” æœå°‹æ¨™é¡Œã€çŸ­ç¢¼æˆ–æ¨™ç±¤..." onkeyup="filterLinks()">
                    <select id="tag-filter" onchange="filterLinks()" style="width: 150px;">
                        <option value="">æ‰€æœ‰æ¨™ç±¤</option>
                    </select>
                </div>
                <div id="links-list">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0;">æ–°å¢é€£çµ</h3>
            <input type="hidden" id="edit-mode" value="create">
            
            <div class="form-group">
                <label>åŸå§‹ç¶²å€ (URL) *</label>
                <input type="url" id="inp-url" placeholder="https://..." onchange="autoFetchTitle()">
            </div>
            
            <div class="form-group">
                <label>æ¨™é¡Œ (Title)</label>
                <input type="text" id="inp-title" placeholder="ç•™ç©ºè‡ªå‹•æŠ“å–">
            </div>

            <div class="row">
                <div class="form-group" style="flex:1">
                    <label>çŸ­ä»£ç¢¼ (ID)</label>
                    <input type="text" id="inp-id" placeholder="ç•™ç©ºè‡ªå‹•ç”¢ç”Ÿ">
                </div>
                <div class="form-group" style="flex:1">
                    <label>åˆ°æœŸæ—¥ (Expiration)</label>
                    <input type="date" id="inp-expiry">
                </div>
            </div>

            <div class="row">
                <div class="form-group" style="flex:1">
                    <label>æ¨™ç±¤ (Tags, é€—è™Ÿåˆ†éš”)</label>
                    <input type="text" id="inp-tags" placeholder="ä¾‹å¦‚: è¡ŒéŠ·, æœƒè­°">
                </div>
                <div class="form-group" style="flex:1">
                    <label>å‚™è¨» (Note)</label>
                    <input type="text" id="inp-note">
                </div>
            </div>

            <div style="margin-top:15px; text-align:right;">
                <button class="secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button onclick="saveLink()" id="btn-save">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="qr-modal" class="modal hidden">
        <div class="modal-content" style="text-align: center; width: 300px;">
            <h3>QR Code</h3>
            <div id="qr-canvas"></div>
            <br>
            <button onclick="downloadQR()">ä¸‹è¼‰åœ–ç‰‡</button>
            <button class="secondary" onclick="document.getElementById('qr-modal').classList.add('hidden')">é—œé–‰</button>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let config = {};
        let allLinks = []; 
        const urlParams = new URLSearchParams(window.location.search);
        const linkId = urlParams.get('id');

        // --- Init ---
        (function init(){
            // é¡¯ç¤ºç‰ˆæœ¬è™Ÿ
            if(document.getElementById('version-display')) {
                document.getElementById('version-display').innerText = SYS_VERSION;
            }

            if (linkId) {
                executeRedirect(linkId);
            } else {
                initAdminView();
            }
        })();

        // --- è¨ªå®¢é‚è¼¯ ---
        function executeRedirect(id) {
            document.getElementById('loading-text').innerText = "é€£çµè§£æä¸­...";
            fetch(`${GAS_URL}?action=getLink&id=${id}`)
                .then(r => r.json())
                .then(d => {
                    if (d.status === "success") {
                        if (d.ga) { loadGA(d.ga); gtag('event', 'short_link_click', {'event_label': id}); }
                        document.getElementById('loading-text').innerText = "å³å°‡å‰å¾€...";
                        setTimeout(() => window.location.replace(d.url), 300);
                    } else if (d.status === "expired") {
                        showStatus("â³ é€£çµå·²éæœŸ", "æ­¤æ´»å‹•æˆ–é€£çµå·²ç¶“çµæŸå¤±æ•ˆã€‚", "expired-box");
                    } else {
                        showStatus("âš ï¸ æ‰¾ä¸åˆ°é€£çµ", "è«‹ç¢ºèªç¶²å€æ˜¯å¦æ­£ç¢ºã€‚", "error-box");
                    }
                })
                .catch(() => showStatus("é€£ç·šéŒ¯èª¤", "è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", "error-box"));
        }

        function showStatus(title, msg, cls) {
            document.getElementById('loading-view').classList.add('hidden');
            const view = document.getElementById('status-view');
            view.innerHTML = `<div class="${cls}"><h3>${title}</h3><p>${msg}</p></div>`;
            view.classList.remove('hidden');
        }

        // --- ç®¡ç†å“¡é‚è¼¯ ---
        function initAdminView() {
            fetch(`${GAS_URL}?action=getConfig`).then(r=>r.json()).then(res=>{
                document.getElementById('loading-view').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                if(res.status==="success") {
                    config = res.data;
                    applyBranding(config);
                }
            });
        }

        function handleLogin() {
            const pwd = document.getElementById('admin-pwd').value;
            if(!pwd) return;
            const btn = document.querySelector('#login-card button');
            btn.innerText = "é©—è­‰ä¸­..."; btn.disabled = true;
            
            fetch(GAS_URL, {method:"POST", body:JSON.stringify({action:"login", password:pwd})})
                .then(r=>r.json()).then(d=>{
                    if(d.status==="success") {
                        document.getElementById('login-card').classList.add('hidden');
                        document.getElementById('dashboard-card').classList.remove('hidden');
                        loadLinks();
                        loadQRLib();
                    } else {
                        alert("å¯†ç¢¼éŒ¯èª¤");
                        btn.innerText = "ç™»å…¥"; btn.disabled = false;
                    }
                });
        }

        function loadLinks() {
            const list = document.getElementById('links-list');
            list.innerHTML = '<div class="loader"></div>';
            fetch(`${GAS_URL}?action=getAll`).then(r=>r.json()).then(res=>{
                if(res.status !== "success") return list.innerHTML = "è¼‰å…¥å¤±æ•—";
                allLinks = res.data;
                updateTagFilter(allLinks);
                renderList(allLinks);
            });
        }

        function renderList(data) {
            const list = document.getElementById('links-list');
            if(data.length === 0) { list.innerHTML = "<p style='text-align:center;color:#999'>ç„¡è³‡æ–™</p>"; return; }
            
            let html = "";
            const origin = window.location.origin + window.location.pathname;
            const today = new Date().toISOString().split('T')[0];

            data.forEach(item => {
                const shortUrl = `${origin}?id=${item.shortId}`;
                const tagsHtml = item.tags ? item.tags.split(',').map(t=>`<span>${t.trim()}</span>`).join('') : '';
                const isExpired = item.expiry && item.expiry < today;
                const expiryHtml = isExpired ? `<span class="expired-tag">å·²éæœŸ</span>` : (item.expiry ? `<small>â³ ${item.expiry}</small>` : '');

                html += `
                <div class="link-item">
                    <div class="link-info">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <strong>${item.title || '(ç„¡æ¨™é¡Œ)'}</strong>
                            ${expiryHtml}
                        </div>
                        <div class="link-tags" style="margin:4px 0;">${tagsHtml}</div>
                        <div class="link-meta">
                            <a href="${shortUrl}" target="_blank" style="color:#3498db;text-decoration:none;">/${item.shortId}</a> 
                            â€¢ ${item.clicks} hits â€¢ ${item.date}
                        </div>
                    </div>
                    <div class="link-actions">
                        <button class="small secondary" onclick="copy('${shortUrl}')">è¤‡è£½</button>
                        <button class="small secondary" onclick="showQR('${shortUrl}')">QR</button>
                        <button class="small warn" onclick='openModal("update", ${JSON.stringify(item)})'>âœï¸</button>
                        <button class="small danger" onclick="deleteLink('${item.shortId}')">ğŸ—‘ï¸</button>
                    </div>
                </div>`;
            });
            list.innerHTML = html;
        }

        function updateTagFilter(data) {
            const tags = new Set();
            data.forEach(i => { if(i.tags) i.tags.split(',').forEach(t => tags.add(t.trim())); });
            const sel = document.getElementById('tag-filter');
            sel.innerHTML = '<option value="">æ‰€æœ‰æ¨™ç±¤</option>' + Array.from(tags).map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function filterLinks() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const tag = document.getElementById('tag-filter').value;
            const filtered = allLinks.filter(i => {
                const matchTerm = (i.title && i.title.toLowerCase().includes(term)) || (i.shortId && i.shortId.toLowerCase().includes(term)) || (i.tags && i.tags.toLowerCase().includes(term));
                const matchTag = tag ? (i.tags && i.tags.includes(tag)) : true;
                return matchTerm && matchTag;
            });
            renderList(filtered);
        }

        // --- Modal & Form ---
        function openModal(mode, item = null) {
            const m = document.getElementById('edit-modal');
            m.classList.remove('hidden');
            document.getElementById('edit-mode').value = mode;
            
            if (mode === 'create') {
                document.getElementById('modal-title').innerText = "æ–°å¢é€£çµ";
                document.getElementById('inp-id').disabled = false;
                clearForm();
            } else { // mode === 'update'
                document.getElementById('modal-title').innerText = "ç·¨è¼¯é€£çµ";
                document.getElementById('inp-id').disabled = true; 
                
                document.getElementById('inp-url').value = item.url;
                document.getElementById('inp-title').value = item.title;
                document.getElementById('inp-id').value = item.shortId;
                document.getElementById('inp-expiry').value = item.expiry || "";
                document.getElementById('inp-tags').value = item.tags || "";
                document.getElementById('inp-note').value = item.note || "";
            }
        }

        function closeModal() { document.getElementById('edit-modal').classList.add('hidden'); }
        function clearForm() { ['inp-url','inp-title','inp-id','inp-expiry','inp-tags','inp-note'].forEach(id=>document.getElementById(id).value=""); }

        function saveLink() {
            const mode = document.getElementById('edit-mode').value;
            const p = {
                action: mode, 
                url: document.getElementById('inp-url').value,
                title: document.getElementById('inp-title').value,
                shortId: document.getElementById('inp-id').value,
                expiry: document.getElementById('inp-expiry').value,
                tags: document.getElementById('inp-tags').value,
                note: document.getElementById('inp-note').value
            };
            
            if(!p.url) return alert("è«‹è¼¸å…¥ç¶²å€");

            const btn = document.getElementById('btn-save');
            btn.disabled = true; btn.innerText = "å„²å­˜ä¸­...";
            
            fetch(GAS_URL, {method:"POST", body:JSON.stringify(p)}).then(r=>r.json()).then(d=>{
                btn.disabled = false; btn.innerText = "å„²å­˜";
                if(d.status === "success") {
                    closeModal();
                    loadLinks(); 
                    alert(mode==="create" ? `å»ºç«‹æˆåŠŸ: ${d.shortId}` : "æ›´æ–°æˆåŠŸï¼");
                } else {
                    alert("å¤±æ•—: " + d.message);
                }
            });
        }
        
        function deleteLink(id) {
            if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿç„¡æ³•å¾©åŸå–”ï¼")) return;
            fetch(GAS_URL, {method:"POST", body:JSON.stringify({action:"delete", id:id})}).then(r=>r.json()).then(()=>loadLinks());
        }
        
        function applyBranding(cfg) {
            if(cfg.SystemTitle) document.title = cfg.SystemTitle;
            if(cfg.ThemeColor) document.documentElement.style.setProperty('--primary', cfg.ThemeColor);
            if(cfg.PageLogo) { document.getElementById('brand-logo').src = cfg.PageLogo; document.getElementById('brand-logo').classList.remove('hidden'); }
            if(cfg.SiteFavicon) document.getElementById('favicon').href = cfg.SiteFavicon;
        }

        function autoFetchTitle() { }
        function copy(t) { navigator.clipboard.writeText(t).then(()=>alert("å·²è¤‡è£½")); }
        function logout() { location.reload(); }
        
        let qrLibLoaded = false, qrCodeObj = null;
        function loadQRLib() {
            if(qrLibLoaded) return;
            const s = document.createElement('script');
            s.src = "https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js";
            s.onload = () => { qrLibLoaded = true; };
            document.body.appendChild(s);
        }
        function showQR(u) {
            if(!qrLibLoaded) return alert("Loading QR Lib...");
            document.getElementById('qr-modal').classList.remove('hidden');
            document.getElementById('qr-canvas').innerHTML = "";
            qrCodeObj = new QRCodeStyling({width:250,height:250,data:u,dotsOptions:{color:config.ThemeColor||"#2c3e50",type:"rounded"}});
            qrCodeObj.append(document.getElementById('qr-canvas'));
        }
        function downloadQR(){ if(qrCodeObj) qrCodeObj.download({name:"qr", extension:"png"}); }
        function loadGA(id) {
            const s = document.createElement('script');
            s.src = `https://www.googletagmanager.com/gtag/js?id=${id}`;
            s.async=true; document.head.appendChild(s);
            window.dataLayer=window.dataLayer||[]; window.gtag=function(){dataLayer.push(arguments);}
            gtag('js',new Date()); gtag('config',id);
        }
    </script>
</body>
</html>
